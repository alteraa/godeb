# Deb Tester

Deb Tester is a lightweight verification tool written in Go designed to validate the installation and removal lifecycle of Debian (`.deb`) packages. It ensures that packages install correctly, place expected files, and clean up thoroughly upon removal.

## Features

- **Lifecycle Verification**: Automates the `Install -> Verify -> Remove -> Verify Clean` cycle.
- **File Validation**:
  - Automatically verifies all files listed in the package (`dpkg -c`) exist after install and are removed after purge.
  - Supports verifying additional "generated files" (e.g., config files created by postinst scripts).
- **Mocking Support**: Can mock external commands (like `systemctl` or `service`) during installation/removal, useful for testing packages in environments (like Docker) where those services might not be available or desired.
- **Stress Testing**: Run the install/remove cycle multiple times (`-repeat`) to ensure distinct idempotency and stability.

## key Components

- **Installer**: Handles `apt-get install` and `apt-get remove --purge`.
- **Verifier**: Checks filesystem state against package contents.
- **Mocker**: Creates temporary shims for external commands in `/usr/local/bin/mocks` and prepends them to `$PATH`.

## Usage

Build the tool (using the provided Dockerfile is recommended to ensure a clean environment):

```bash
docker build -t deb-tester .
```

Run the tool against a target deb file:

```bash
deb-tester [flags] <path-to-deb>
```

### Flags

| Flag | Description | Default |
|------|-------------|---------|
| `-repeat <n>` | Number of times to repeat the install/remove cycle. | `1` |
| `-verify-files <list>` | Semicolon-separated list of critical files to verify manually. | `""` |
| `-verify-generated-files <list>` | Semicolon-separated list of files generated by maintainer scripts (not in the deb itself). | `""` |
| `-mock <list>` | Semicolon-separated list of commands to mock (e.g., `systemctl;service`). | `""` |

### Example

Test the provided example package:

```bash
# First, build the example package (if not already built)
cd example && cmake . && make && cpack -G DEB && cd ..

# Run deb-tester against it
deb-tester ./example/example-deb-pkg-1.0.0-Linux.deb
```

## Example Package

The `/example` directory contains a sample project that can be used to test `deb-tester`. 

### Features of Example Package
- Minimal C++ binary (`/usr/bin/example-deb-bin`).
- Full set of maintainer scripts (`preinst`, `postinst`, `prerm`, `postrm`) for lifecycle testing.
- Built using **CMake** and **CPack**.

### Building the Example Package
To generate the `.deb` file for testing:
```bash
cd example
cmake .
make
cpack -G DEB
```
This will produce `example-deb-pkg-1.0.0-Linux.deb` in the `example` directory.
